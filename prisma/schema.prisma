generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  cpf       String   @unique

  // üîπ Campos adicionais para melhorar match quality no Meta e identifica√ß√£o de usu√°rio
  email     String?  @unique        // email do usu√°rio (hashado no CAPI)
  phone     String?                  // telefone com DDI, ex: 5599999999999
  firstName String?                  // primeiro nome
  lastName  String?                  // sobrenome
  city      String?                  // cidade (para user_data do Meta)
  state     String?                  // estado (UF)
  zip       String?                  // CEP
  country   String?  @default("BR")  // pa√≠s (BR por padr√£o)

  createdAt DateTime @default(now())
  orders    Order[]
}

model Order {
  id        String   @id @default(uuid())
  userId    String
  amount    Float
  quantity  Int      @default(0)          // üëà NOVO CAMPO: qtd total de n√∫meros
  status    String   @default("pending")  // pending, paid, canceled
  createdAt DateTime @default(now())

  // üîπ Campo para integra√ß√£o com Meta CAPI
  // Usado como event_id para deduplica√ß√£o entre browser e servidor
  metaEventId String?                   // event_id usado no Meta (CAPI / Pixel)

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  tickets      Ticket[]

  @@index([userId])
  @@index([status])
}

model Transaction {
  id        String   @id @default(uuid())
  orderId   String
  value     Float
  status    String   @default("pending") // pending, paid, failed
  gatewayId String?                      // ID retornado pelo gateway
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model Ticket {
  id        String   @id @default(uuid())
  orderId   String
  number    Int
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([number])
}
